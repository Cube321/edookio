<% layout ('layouts/boilerplate.ejs') %>

<div class="row mb-3" id="sections-container">
  <!-- CATEGORY left box (ikon + name) -->
  <div class="col-md-4 col-lg-3 offset-lg-1 mb-3">
    <div class="card">
      <div
        class="card-body category-box d-flex flex-column align-items-center justify-content-center pt-4"
      >
        <div
          class="rounded-circle icon-background-large d-flex justify-content-center align-items-center"
        >
          <img src="/img/<%= category.icon %>" class="img-fit" alt="" />
        </div>
        <h4 class="mt-4 mb-2"><%= title %></h4>
        <p class="text-center">
          <% if (knownPercentageOfCategory >= 100) { %>
          <span
            class="badge section-progress-badge badge-green-full"
            title="Míra splnění předmětu"
            >100 %</span
          >
          <% } else if (knownPercentageOfCategory > 89) { %>
          <span
            class="badge section-progress-badge badge-green-outline"
            title="Míra splnění předmětu"
            ><%= knownPercentageOfCategory %> %</span
          >
          <% } else { %>
          <span
            class="badge section-progress-badge badge-grey-outline"
            title="Míra splnění předmětu"
            ><%= knownPercentageOfCategory %> %</span
          >
          <% } %>
        </p>
        <div>
          <% if (category.numOfCards > 0) { %>
          <div
            class="mb-2 mt-3 px-3 py-2 category-info d-flex align-items-center justify-content-between"
          >
            <p class="mb-0">
              <b><%= category.numOfCards %></b> <%=
              texts.categoryPage.cardsToStudy %>
            </p>
            <% if (currentUser) { %>
            <a
              href="/category/<%= category._id %>/randomCards"
              class="btn btn-sm btn-outline-danger mx-2"
              style="border: none"
              ><i class="fas fa-random"></i
            ></a>
            <% } %>
          </div>
          <% } %> <% if (category.numOfQuestions > 0) { %>
          <div
            class="mb-2 mt-3 px-3 py-2 category-info d-flex align-items-center justify-content-between"
          >
            <p class="mb-0">
              <b><%= category.numOfQuestions %></b> testových otázek
            </p>
            <% if (currentUser) { %>
            <a
              href="/category/<%= category._id %>/testRandom"
              class="btn btn-sm btn-outline-danger mx-2"
              style="border: none"
              ><i class="fas fa-random"></i
            ></a>
            <% } %>
          </div>
          <% } %>
        </div>
      </div>
      <% if(!currentUser || (currentUser && !currentUser.usedMobileApp)){ %>
      <div
        class="card-body d-flex flex-column align-items-center justify-content-center"
      >
        <p class="text-center">
          Vyzkoušej i <b>mobilní aplikaci</b>
          <b class="color-primary">Edookio</b>!
        </p>
        <div class="d-flex justify-content-evenly align-items-center">
          <a
            href="https://apps.apple.com/us/app/inlege/id6740498818"
            target="_blank"
            class="btn btn-outline-danger mx-2 text-small"
            ><i class="fab fa-apple"></i>
            <span class="hide-under-1200">iOS</span></a
          >
          <a
            href="https://play.google.com/store/apps/details?id=com.edookio.edookio"
            target="_blank"
            class="btn btn-outline-danger mx-2 text-small"
            ><i class="fab fa-android"></i>
            <span class="hide-under-1200">Android</span></a
          >
        </div>
      </div>
      <% } %> <% if(currentUser && !currentUser.isEmailVerified){ %>
      <div class="row">
        <div class="col-12">
          <div class="card border-grey m-2">
            <div
              class="card-body card-info d-flex flex-row align-items-center justify-content-around"
            >
              <p class="text-center mb-0">
                Ověř prosím svou <b>e-mailovou adresu</b>
              </p>
              <a
                href="/auth/user/requestEmailVerification"
                class="btn btn-sm btn-danger mx-2"
                >Ověřit</a
              >
            </div>
          </div>
        </div>
      </div>
      <% } %>
      <div class="row mb-3 mt-2">
        <div class="col-12 d-flex justify-content-center">
          <a
            href="#"
            class="btn btn-danger"
            data-bs-toggle="modal"
            data-bs-target="#shareModal"
            >Sdílet předmět <i class="fas fa-share-alt"></i
          ></a>
        </div>
      </div>
    </div>
  </div>

  <!-- CATEGORY - list of sections -->
  <div class="col-md-8 col-lg-7 section-list">
    <!-- CATEGORY - list of sections -->
    <div class="card mb-2">
      <div class="card-body">
        <div class="row">
          <div class="col-3">
            <h5 class="m-0 mb-1 mt-1">Balíčky</h5>
          </div>
          <div class="col-8 d-flex justify-content-end align-items-center">
            <% if (isAuthor) { %>
            <a
              href=""
              class="btn btn-sm btn-danger mx-2"
              data-bs-toggle="modal"
              data-bs-target="#createWithAIModal"
              >Generovat pomocí AI</a
            >
            <a
              href=""
              class="btn btn-sm btn-outline-danger mx-2"
              data-bs-toggle="modal"
              data-bs-target="#createWithoutAIModal"
              >Vytvořit bez AI</a
            >
            <% } %>
          </div>
          <div class="col-1 d-flex justify-content-end align-items-center">
            <% if (currentUser) { %>
            <a
              href=""
              class="color-text"
              id="menu-icon"
              data-bs-toggle="modal"
              data-bs-target="#sectionSettingsModal"
              ><i class="fas fa-bars"></i
            ></a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% if (category.sections.length < 1) { %>
    <div class="card mb-3">
      <div
        class="card-body d-flex flex-column align-items-center justify-content-center p-5"
      >
        <h5 class="text-center">
          Tento předmět zatím neobsahuje žádné balíčky.
        </h5>
        <% if (isAuthor) { %>
        <div class="d-flex justify-content-center align-items-center">
          <a
            href=""
            class="btn btn-danger mt-3 mx-2"
            data-bs-toggle="modal"
            data-bs-target="#createWithAIModal"
            >Generovat pomocí AI</a
          >
          <a
            href=""
            class="btn btn-outline-danger mt-3 mx-2"
            data-bs-toggle="modal"
            data-bs-target="#createWithoutAIModal"
            >Vytvořit bez AI</a
          >
        </div>
        <% } %>
      </div>
    </div>
    <% } else { category.sections.forEach(section => { %>
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div
            class="col-lg-8 col-12 d-flex flex-column justify-content-between"
          >
            <div>
              <p class="m-0 section-name"><%= section.name %></p>
              <p class="text-muted text-small mb-1">
                <%= section.cards.length %> kartiček / <%=
                section.questions.length %> otázek
              </p>
            </div>
            <div>
              <% if (isAuthor) { %>
              <a
                href="#"
                class="text-small"
                data-bs-toggle="modal"
                data-bs-target="#editSectionModal<%=section._id%>"
                ><i class="fas fa-cog"></i> Upravit</a
              >
              <% } %>
            </div>
          </div>
          <div class="col-lg-2 col-6">
            <% if (section.cards.length) { %>
            <div class="section-box">
              <p>Kartičky</p>
              <div>
                <% if (section.knownPercentage === 100) { %>
                <span
                  class="badge section-progress-badge badge-green-full"
                  title="Umíš <%= section.knownCount %> z <%= section.cards.length %> kartiček"
                  ><%= section.knownCount %> / <%= section.cards.length %></span
                >
                <% } else if (section.knownPercentage > 90) { %>
                <span
                  class="badge section-progress-badge badge-green-outline"
                  title="Umíš <%= section.knownCount %> z <%= section.cards.length %> kartiček"
                  ><%= section.knownCount %> / <%= section.cards.length %></span
                >
                <% } else { %>
                <span
                  class="badge section-progress-badge badge-grey-outline"
                  title="Umíš <%= section.knownCount %> z <%= section.cards.length %> kartiček"
                  ><%= section.knownCount %> / <%= section.cards.length %></span
                >
                <% } %>
              </div>
              <div>
                <a
                  href="/category/<%= category._id %>/section/<%= section._id %>/card30/1?mode=unknown"
                  class="btn btn-sm btn-danger btn-spustit w-100 mt-2"
                  >Spustit</a
                >
              </div>
            </div>
            <% } else { %>
            <div class="section-box">
              <p>Kartičky</p>
              <div>
                <span
                  class="badge section-progress-badge badge-grey-outline"
                  title="Umíš 0 z 0 kartiček"
                  >0 / 0</span
                >
              </div>
              <div>
                <a
                  href="/category/<%= category._id %>/section/<%= section._id %>/card30/1?mode=unknown"
                  class="btn btn-sm btn-danger btn-spustit w-100 mt-2 disabled"
                  >Spustit</a
                >
              </div>
            </div>
            <% } %>
          </div>
          <div class="col-lg-2 col-6">
            <% if (section.questions.length) { %>
            <div class="section-box">
              <p>Otázky</p>
              <div>
                <% if (section.isFinishedQuestions) { %> <% if
                (section.lastTestResult === 100) { %>
                <span
                  class="badge section-progress-badge badge-green-full"
                  title="Tvá úspěšnost v posledním testu"
                  >100 %</span
                >
                <% } else if (section.lastTestResult > 90) { %>
                <span
                  class="badge section-progress-badge badge-green-outline"
                  title="Tvá úspěšnost v posledním testu"
                  ><%= section.lastTestResult %> %</span
                >
                <% } else { %>
                <span
                  class="badge section-progress-badge badge-grey-outline"
                  title="Tvá úspěšnost v posledním testu"
                  ><%= section.lastTestResult %> %</span
                >
                <% } %> <% } else { %>
                <span
                  class="badge section-progress-badge badge-grey-outline"
                  title="Tento test jsi ještě neabsolvoval"
                  >0 %</span
                >
                <% } %>
              </div>
              <div>
                <a
                  href="/category/<%= category._id %>/section/<%= section._id %>/test"
                  class="btn btn-sm btn-danger btn-spustit w-100 mt-2"
                  >Spustit</a
                >
              </div>
            </div>
            <% } else { %>
            <div class="section-box">
              <p>Otázky</p>
              <div>
                <span
                  class="badge section-progress-badge badge-grey-outline"
                  title="Tento test jsi ještě neabsolvoval"
                  >0 %</span
                >
              </div>
              <div>
                <a
                  href="/category/<%= category._id %>/section/<%= section._id %>/test"
                  class="btn btn-sm btn-danger btn-spustit w-100 mt-2 disabled"
                  >Spustit</a
                >
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <% })} %>
  </div>
</div>

<div
  id="loader"
  style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  "
>
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- MODAL - Section Settings (Flexbox version) -->
<div class="modal fade" id="sectionSettingsModal" tabindex="-1">
  <div
    class="modal-dialog modal-dialog-centered modal-dialog-scrollable edit-modal"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nastavení předmětu</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Resetování kartiček -->
        <div class="d-flex flex-column mb-3">
          <h6 class="mb-2">Resetování kartiček</h6>
          <div
            class="d-flex justify-content-between align-items-center flex-sm-row flex-column"
          >
            <p class="me-3 flex-grow-1 text-smaller">
              Resetování kartiček znamená, že informace o tom, které kartičky
              umíš a které ne budou odstraněny a začneš studovat tento předmět
              od začátku.
            </p>
            <a
              href="/category/<%= category._id %>/resetCards"
              class="btn btn-danger btn-sm"
              >Resetovat</a
            >
          </div>
        </div>
        <hr />
        <!-- Resetování otázek -->
        <div class="d-flex flex-column">
          <h6 class="mb-2">Resetování otázek</h6>
          <div
            class="d-flex justify-content-between align-items-center flex-sm-row flex-column"
          >
            <p class="me-3 flex-grow-1 text-smaller">
              Resetování otázek znamená, že tvé výsledky testů v tomto předmětu
              budou odstraněny.
            </p>
            <a
              href="/category/<%= category._id %>/resetQuestions"
              class="btn btn-danger btn-sm"
              >Resetovat</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL - Share section -->
<div class="modal fade" id="shareModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <h3 class="text-center">Sdílej předmět s přáteli</h3>
        <div>
          <div class="d-flex justify-content-center align-items-center">
            <span class="card border-grey m-3 px-5 py-3 shareIdSpan"
              ><%= category.shareId %></span
            >
          </div>
        </div>
        <div>
          <p class="text-center mb-3">nebo</p>
        </div>
        <div class="d-flex justify-content-center align-items-center">
          <input
            type="text"
            class="form-control"
            value="<%= shareLink %>"
            id="shareLink"
          />
          <button class="btn btn-danger mx-2" id="shareLinkButton">
            <i class="far fa-copy"></i>
          </button>
        </div>
        <div class="mt-3">
          <p
            class="text-primary text-center hidden"
            id="copy-confirmation-text"
          >
            Zkopírováno do schránky
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pouze owner - formular pro pridani sekce -->
<% if (isAuthor) { %>
<!-- MODAL - Create section with AI -->
<div class="modal fade" id="createWithAIModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vytvořit nový balíček (pomocí AI)</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body m-2 pt-0">
        <div id="document-formats-container">
          <p class="text-muted text-smaller mb-1">
            Nahrajte soubor ve formátu .docx, .pdf nebo .pptx.
          </p>
          <p class="text-muted text-smaller mb-3">
            Máte k dispozici
            <b><%= currentUser.credits + currentUser.extraCredits %></b>
            kreditů.
          </p>
        </div>
        <form
          action="/category/<%= category._id  %>/newSectionFromDocument"
          id="add-section-with-ai-form"
          method="POST"
          enctype="multipart/form-data"
        >
          <div class="form-group row">
            <label for="name" class="col-lg-4 col-form-label">Název</label>
            <div class="col-lg-8">
              <input
                type="text"
                class="form-control form-borders"
                id="name"
                name="name"
                required
              />
            </div>
          </div>
          <div class="row mt-2">
            <label
              for="desc"
              class="col-lg-4 col-form-label d-flex align-items-center"
              >Kartiček/strana
              <span
                class="question-mark-box"
                title="Kolik kartiček / otázek má být vygenerováno z jedné normostrany textu"
                >?</span
              ></label
            >
            <div class="col-lg-8">
              <div class="scale-container">
                <input
                  type="range"
                  class="scale-input"
                  name="cardsPerPage"
                  min="1"
                  max="8"
                  step="1"
                  value="4"
                />
                <div class="scale-labels">
                  <span>1</span>
                  <span>2</span>
                  <span>3</span>
                  <span>4</span>
                  <span>5</span>
                  <span>6</span>
                  <span>7</span>
                  <span>8</span>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <label
              for="desc"
              class="col-lg-4 col-form-label d-flex align-items-center"
              >Velikost balíčku
              <span
                class="question-mark-box"
                title="Kolik kartiček/otázek má být v jednom balíčku"
                >?</span
              ></label
            >
            <div class="col-lg-8">
              <div class="scale-container">
                <input
                  type="range"
                  class="scale-input"
                  name="sectionSize"
                  min="10"
                  max="30"
                  step="5"
                  value="20"
                />
                <div class="scale-labels">
                  <span>10</span>
                  <span>15</span>
                  <span>20</span>
                  <span>25</span>
                  <span>30</span>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-5">
            <label for="document" class="col-lg-4 col-form-label"
              >Nahrát dokument</label
            >
            <div class="col-lg-8">
              <input
                class="form-control form-borders border-darkgrey"
                type="file"
                id="document"
                name="document"
                accept=".pdf, .docx, .pptx"
                required
              />
              <% if (currentUser && !currentUser.isPremium){ %>
              <p class="text-muted text-smaller my-1">
                Maximální rozsah textu je 25 stran -
                <a href="/premium">zvýšit na 150 stran</a>.
              </p>
              <% } else { %>
              <p class="text-muted text-smaller my-1">
                Maximální rozsah textu je 150 stran (270 000 znaků).
              </p>
              <% } %>
            </div>
          </div>
          <div class="row">
            <div class="col-12 d-flex justify-content-center mt-3">
              <button class="btn btn-danger w-100" id="add-section-with-ai-btn">
                Vygenerovat balíček z dokumentu
              </button>
            </div>
          </div>
        </form>
        <div id="document-progress-container">
          <h5 class="mt-3 text-center mb-3">Generuji kartičky a otázky...</h5>
          <div id="progress-bar-container">
            <div id="progress-bar"></div>
          </div>
          <p id="progress-text">Čekám na nahrání souboru...</p>
        </div>
        <div id="document-success-container" style="display: none">
          <h5 class="mt-3 text-center">Dokončeno!</h5>
          <p id="document-success-text" class="text-center">
            Zbývá vám ještě 0 kreditů.
          </p>
          <p class="text-smaller text-muted text-center">
            Za vytvoření každé kartičky nebo testové otázky se vám odečte jeden
            kredit.
          </p>
        </div>
        <div id="document-error-container" style="display: none">
          <h5 class="mt-3 text-center" id="document-error-headline">
            Generování selhalo
          </h5>
          <hr class="color-primary mx-5" style="height: 2px" />
          <p class="text-center" id="document-error-text"></p>
          <div class="d-flex justify-content-center">
            <a
              href="/premium"
              id="premium-button"
              class="btn btn-danger mt-2"
              style="display: none"
              >Zvýšit limit na 150 stran</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL - Create section without AI -->
<div class="modal fade" id="createWithoutAIModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vytvořit nový balíček (bez AI)</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body m-3">
        <form
          action="/category/<%= category._id  %>/newSection"
          id="add-section-without-ai-form"
          method="POST"
        >
          <div class="form-group row">
            <div class="col-lg-12">
              <input
                type="text"
                class="form-control form-borders"
                id="name"
                placeholder="Název"
                name="name"
                required
              />
            </div>
          </div>
          <div class="row">
            <div class="col-12 d-flex justify-content-center mt-3">
              <button class="btn btn-danger" id="add-section-without-ai-btn">
                Přidat balíček
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<% } %> <% if (category.sections.length > 0 && isAuthor) { %> <%
category.sections.forEach(section => { %>
<!-- MODAL - Edit section -->
<div class="modal fade" id="editSectionModal<%=section._id%>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upravit balíček</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="row mx-2">
          <div class="col-12 d-flex justify-content-between">
            <h5><%= section.name %></h5>
            <a
              href="/category/<%= category._id %>/editSection/<%= section._id %>"
              class="text-smaller"
              >změnit</a
            >
          </div>
        </div>

        <div class="row mb-2 mt-2 d-flex mx-3">
          <a
            href="/review/<%= section._id %>/showAll"
            class="btn btn-sm btn-danger my-1"
            ><i class="far fa-edit"></i> Editovat obsah</a
          >
          <div class="d-flex justify-content-between align-items-center p-0">
            <a
              href="/category/<%= category._id %>/section/<%= section._id %>/newCard"
              class="btn btn-sm btn-outline-danger my-1 w-100"
              style="margin-right: 4px"
              ><i class="far fa-plus-square"></i> Přidat kartičku</a
            >
            <a
              href="/category/<%= category._id %>/section/<%= section._id %>/question/new"
              class="btn btn-sm btn-outline-danger my-1 w-100"
              style="margin-left: 4px"
              ><i class="far fa-plus-square"></i> Přidat otázku</a
            >
          </div>
        </div>
        <div class="row mb-2 mt-3 mx-3 d-flex">
          <a
            href="#"
            class="btn btn-sm btn-danger btn-red my-1"
            data-bs-toggle="modal"
            data-bs-target="#deleteSectionModal<%=section._id%>"
            ><i class="far fa-trash-alt"></i> Odstranit balíček</a
          >
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL - Delete section -->
<div class="modal fade" id="deleteSectionModal<%=section._id%>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Opravdu chcete odstranit tento balíček?</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center">
        <form
          action="/category/<%= category._id %>/removeSection/<%= section._id %>?_method=DELETE"
          method="POST"
        >
          <button class="btn btn-sm btn-danger">Ano, odstranit</button>
        </form>
      </div>
    </div>
  </div>
</div>
<% }) %> <% } %> <% if (isAuthor) { %>
<script src="/js/document.js"></script>
<% } %> <% if(currentUser && !currentUser.appAnnouncementModalShown){ %>
<!-- MODAL - App Anouncement with script -->
<div class="modal fade" id="appAnouncementModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered edit-modal">
    <div class="modal-content">
      <div class="modal-body">
        <div class="d-flex justify-content-between w-100">
          <div></div>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <h3 class="text-center mt-3">Mobilní aplikace InLege je tady!</h3>
        <p class="text-center">
          Stáhni si aplikaci InLege a uč se kdekoli a kdykoli!
        </p>
        <div class="d-flex justify-content-center mt-4">
          <a
            href="https://apps.apple.com/us/app/inlege/id6670204630"
            target="_blank"
            class="btn btn-danger mx-2"
            >App Store</a
          >
          <a
            href="https://play.google.com/store/apps/details?id=cz.inlege.InLege&hl=en"
            target="_blank"
            class="btn btn-danger mx-2"
            >Google Play</a
          >
        </div>
        <div>
          <img
            src="/img/inlege_app_mock.png"
            alt="InLege App"
            class="img-fluid"
          />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var appAnouncementModal = new bootstrap.Modal(
      document.getElementById("appAnouncementModal")
    );
    appAnouncementModal.show();
  });
  //send post request to /admin/appAnnounced to set appAnnouncementModalShown to true to prevent showing the modal again
  fetch("/api/appAnnounced", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({}),
  });
</script>
<% } %>
